digraph isa_core_diagram {

    ratio=fill;
    node [shape=record style=rounded];
    edge [arrowhead=none arrowtail=crow dir=both];

    subgraph cluster_0 {

        label="study";

        person [label="{person|\
        id [PK: serial] \l\
        //orcid [UNIQUE: text]\l\
        last_name [text]\l\
        first_name [text]\l\
        mid_initials [text]\l\
        email [text]\l\
        phone [text]\l\
        fax [text]\l\
        address [text]\l\
        affiliation [FK]\l\
        }"];


        project [label="{project|\
        id [PK: serial] \l\
        name [text]\l\
        principal_investigator [FK]\l\
        funding [text]\l\
        }"];

        study [label="{study|\
        id [PK: serial] \l\
        accession_number [PK: text] \l\
        title [text]\l\
        description [text]\l\
        project [FK]\l\
        experiment_type [V]\l\
        data_type [V] \l\
        submission_date [date]\l\
        public_release_date [date]\l\
        local_identifier [text]\l\
        }"];


        publication [label="{publication|\
        id [PK: serial] \l\
        investigation_id [FK] \l\
        study_id [FK] \l\
        pubmed_id [UNIQUE: text]\l\
        doi [UNIQUE: text]\l\
        title [text]\l\
        status [FK] \l\
        }"];



        "assay" [label="{assay|\
        id [PK:serial] \l\
        accession_number [UNIQUE: text] \l\
        study_id [FK] \l\
        name \l\
        description \l\
        measurement_type (V:OBI) \l\
        technology_type (V:OBI) \l\
        technology_platform (V:OBI) \l\
        }"]



        project -> person ;
        study -> project ;
        publication -> study ;
        "assay" -> study ;

        { rank=same; study; assay}
    }


    subgraph cluster_2 {

        label="assay";

        // this could be a file type instead of assay type
        "imaging" [label="{imaging|\
        assay_id [PK][FK] \l\
        modality (V) \l\
        equipment_model (V) \l\
        intent (V) \l\
        caption \l\
        dimensionality \l\
        voxel_x \l\
        voxel_y \l\
        voxel_z \l\
        image_size_x \l\
        image_size_y \l\
        image_size_z \l\
        }"];


        "enhancer" [label="{enhancer|\
        assay_id [PK][FK] \l\
        original_species_assembly [text] \l\
        original_species_chromosome [text] \l\
        original_species_start [int] \l\
        original_species_end [int] \l\
        visualization_assembly [text] \l\
        visualization_assembly_chromosome [text] \l\
        visualization_assembly_start [int] \l\
        visualization_assembly_end [int] \l\
        other_assembly [text] \l\
        other_assembly_chromosome [text] \l\
        other_assembly_start [int] \l\
        other_assembly_end [int] \l\
        tested_sequence [text] \l\
        tested_sequence_flag [text] \l\
        list_of_closest_genes [V] \l\
        external_database_name [text] \l\
        external_id [text] \l\
        list_of_anatomical_structures [V] \l\
        lab_internal_reference [text] \l\
        }"]


        "replicate" [label="{replicate|\
        assay_id [PK][FK] \l\
        sample_composition \l\
        sample_type \l\
        molecule_type \l\
        sample_purification \l\
        markers \l\
        isolation_protocol \l\
        cell_count \l\
        protocol \l\
        pretreatment \l\
        fragmentation_method \l\
        reagent \l\
        reagent_source \l\
        reagent_catalog_number \l\
        reagent_batch_number \l\
        selection \l\
        tracks_id [FK] \l\
        library_id [FK] \l\
        allignment_id [FK] \l\
        }"]


        "library" [label="{library|\
        id [PK] \l\
        library_type \l\
        single_paired_end_sequencing \l\
        library_adapters \l\
        pcr_cycles \l\
        library_yield \l\
        size_selection \l\
        platform\l\
        }"]

        "alignment" [label="{alignment|\
        id [PK] \l\
        aligner \l\
        aligner_version \l\
        aligner_flags \l\
        reference_genome \l\
        transcriptome_model \l\
        sequence_trimming \l\
        trimmed_seqs \l\
        trimming_method \l\
        duplicate_removal \l\
        prealign_seq_removal \l\
        }"]

        // Like imaging, this could possibly be an extension of the file? Or
        // maybe have a FK to the file?
        "tracks" [label="{tracks|\
        id [PK] \l\
        format \l\
        software \l\
        version \l\
        settings \l\
        }"]

        file [label="{file|\
        id [PK: serial] \l\
        accession_number [UNIQUE: text]\l\
        assay_id [FK] \l\
        uri [UNIQUE: text]\l\
        doi [UNIQUE: text]\l\
        ark [UNIQUE: text]\l\
        description [text]\l\
        source_filename [text]\l\
        size_in_bytes [int]\l\
        checksum_type [V:TBD] \l\
        checksum [text?]\l\
        file_format [V:TBD]\l\
        creation_date [date]\l\
        submission_date [date]\l\
        }"];



        { rank=same; "imaging" "enhancer" "replicate" }
        { rank=same; "library" "alignment" "tracks" }
        "enhancer" -> "assay";
        "replicate" -> "assay";
        "imaging" -> "assay";
        "file" -> "assay";
        "replicate" -> { "library" "alignment" "tracks" } [arrowtail=none, arrowhead=teedot, dir=both, label=""]
    }


    subgraph cluster_3 {

        label="sample";

        // If we need to support multiple phenotypes and anatomical sources
        // per sample, then those fields need to be split out into separate
        // tables to support the 1:N relationship.
        "mouse_sample" [label="{mouse_sample|\
        assay_id [PK][FK]\l\
        local_identifier\l\
        gene (V)\l\
        genotype (V)\l\
        specimen (V)\l\
        phenotype (V)\l\
        anatomy (V)\l\
        stage (V)\l\
        strain (V) \l\
        gender (V) \l\
        litter (V) \l\
        origin (V) \l\
        mutation (V) \l\
        collection_date \l\
        }"];


        // if we need to support multiple phenotypes and anatomical sources
        // per sample, then those fields need to be split out into separate
        // tables to support the 1:N relationship.
        "zebrafish_sample" [label="{zebrafish_sample|\
        assay_id [PK][FK] \l\
        local_identifier \l\
        gene (V)\l\
        genotype (V)\l\
        specimen (V) \l\
        phenotype (V) \l\
        anatomy (V) \l\
        stage (V) \l\
        strain (V) \l\
        gender (V) \l\
        origin (V) \l\
        mutation (V) \l\
        collection_date \l\
        }"];

        "human_sample" [label="{human_sample|\
        assay_id [PK][FK] \l\
        local_identifier \l\
        gene (V)\l\
        genotype \l\
        specimen (V) \l\
        phenotype (V) \l\
        anatomy (V) \l\
        strain \l\
        gender \l\
        mutation \l\
        embryonic_stage (V) \l\
        collection_date \l\
        clinical [FK] \l\
        }"];

        "clinical" [label="{clinical|\
        id [PK: serial] \l\
        age \l\
        height \l\
        weight \l\
        head_circumference \l\
        OMIM_diagnosis (V:OMIM) \l\
        OMIM_code (V:OMIM) \l\
        ICD10_diagnosis (V:ICD10) \l\
        ICD10_code (V:ICD10) \l\
        molecular_cytogenetic_diagnosis (V) \l\
        diagnostic_evidence_notes \l\
        }"]; 

        "mouse_sample" -> "assay" ;
        "zebrafish_sample" -> "assay" ;
        "human_sample" -> "assay"

        "human_sample" ->  "clinical" [arrowtail=none, arrowhead=teedot, dir=both, label=""]

        { rank=same; "mouse_sample" "zebrafish_sample" "human_sample" }

    }


    /* Begin Notes section
     */
    node [shape=note style=filled fillcolor=yellow];
    edge [arrowhead=none];

    //note [label="'[V:xyz]' is short-hand for a FK\l\to a concept table for 'xyz'.\l\Many columns in this model\l\depend on the 'OBI' vocabulary."];
}

